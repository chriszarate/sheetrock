/*
 * jQuery Sheetrock v0.1.5
 * Quickly connect to, query, and lazy-load data from Google Spreadsheets
 * Requires jQuery >=1.6
 * http://github.com/chriszarate/sheetrock
 */
!function(a){"use strict";"function"==typeof define&&define.amd?define("jquery.sheetrock",["jquery"],a):a(window.jQuery)}(function(a){"use strict";a.fn.sheetrock=function(a,b){return a.target=this.length?this:!1,a=t(a),a&&(y(b)&&null!==b?h(a,b):g(a)),this};var b={},c=0,d="sheetrockError",e="sheetrockLoaded",f="sheetrockRowOffset",g=function(b){a.fn.sheetrock.promise=a.fn.sheetrock.promise.pipe(function(){return i(b)}).pipe(function(){return j(b)})},h=function(a,b){k(a),l.call(a,b),n.call(a)},i=function(b){var c={sql:"select * limit 1",dataHandler:r,userCallback:a.noop,target:!1};return-1===b.sql.indexOf("%")||s(b)?a.Deferred().resolve():(z("Prefetching column labels."),j(a.extend({},b,c)))},j=function(b){k(b),b.chunkSize&&b.target&&(b.sql+=" limit "+(b.chunkSize+1)+" offset "+b.offset,B(b.target,f,b.offset+b.chunkSize)),b.callback="sheetrock_"+c++;var d={data:u(b),context:b,url:a.fn.sheetrock.server,dataType:"jsonp",cache:!0,jsonp:!1,jsonpCallback:b.callback};return z(d,b.debug),a.ajax(d).promise().done(l).fail(m).always(n)},k=function(b){b.loading.show(),a.fn.sheetrock.working++},l=function(a){o(a,"warnings"),o(a,"errors"),z(a,this.debug),x(a,"status","table")&&x(a.table,"cols","rows")?this.dataHandler.call(p.call(this,a),a):m.call(this,a)},m=function(){B(this.target,d,1),z("Request failed.")},n=function(){this.loading.hide(),this.userCallback(this),a.fn.sheetrock.working--},o=function(b,c){x(b,c)&&a.each(b[c],function(a,b){x(b,"detailed_message")?z(b.detailed_message):x(b,"message")&&z(b.message)})},p=function(b){var c=this;return c.parsed={},c.parsed.last=c.chunkSize?Math.min(b.table.rows.length,c.chunkSize):b.table.rows.length,c.parsed.loaded=!c.chunkSize||c.parsed.last<c.chunkSize?1:0,c.parsed.header=a.map(b.table.cols,F).length?1:0,c.parsed.labels=c.labels&&c.labels.length===b.table.cols.length?c.labels:a.map(b.table.cols,G),B(c.target,e,c.parsed.loaded),c},q=function(b){var c=this,d=c.target;a.extend(c,{thead:c.rowGroups?a("<thead/>").appendTo(d):d,tbody:c.rowGroups?a("<tbody/>").appendTo(d):d}),c.offset||c.headersOff||(c.parsed.header||!c.headers)&&c.thead.append(c.rowHandler({num:0,cells:J(c.parsed.labels)})),a.each(b.table.rows,function(b,d){if(x(d,"c")&&b<c.parsed.last){var e=w(c.offset+b+1+c.parsed.header-c.headers),f={num:e,cells:{}};(e||!c.headersOff)&&(a.each(d.c,function(a,b){var d=c.formatting?K(b):!1,e=b&&x(b,"v")?c.cellHandler(b.v):"";f.cells[c.parsed.labels[a]]=d?M(e,"span",d):e}),f.num?c.tbody.append(c.rowHandler(f)):c.thead.append(c.rowHandler(f)))}}),c.target.children("tr:has(th)").wrap("<thead></thead>")},r=function(c){var d={};a.each(c.table.cols,function(a,b){d[b.id]=G(b)}),b[this.key+this.gid]=d},s=function(c){return a.isEmptyObject(c.columns)?b[c.key+c.gid]||!1:c.columns},t=function(b){return b=a.extend({},a.fn.sheetrock.options,b),b.key=C(b.url),b.gid=D(b.url),b.chunkSize=b.target?w(b.chunkSize):0,b.headers=w(b.headers),b.offset=b.chunkSize?A(b.target,f):0,b.loading=I(b.loading),b.target||b.dataHandler!==q?A(b.target,e)?z("No more rows to load!"):A(b.target,d)?z("A previous request for this resource failed."):b.url?b.key?b.gid?(z(b,b.debug),b):z("Could not find a gid in the provided URL."):z("Could not find a key in the provided URL."):z("No spreadsheet URL provided."):z("No element targeted or data handler provided.")},u=function(a){var b={key:a.key,gid:a.gid,tqx:"responseHandler:"+a.callback};return a.sql&&(b.tq=H(a.sql,s(a))),b},v=function(a){return a.toString().replace(/^ +/,"").replace(/ +$/,"")},w=function(a){return Math.max(0,parseInt(a,10)||0)},x=function(a){for(var b=1;b<arguments.length;b++)if(!y(a[arguments[b]]))return!1;return!0},y=function(a){return"undefined"==typeof a?!1:!0},z=function(a,b){return b=!y(b)||y(b)&&b,b&&window.console&&console.log&&console.log(a),!1},A=function(b,c){return b.length?a.data(b[0],c)||0:0},B=function(b,c,d){return b.length?a.data(b[0],c,d)||0:0},C=function(a){var b=new RegExp("key=([^&#]+)","i");return b.test(a)?a.match(b)[1]:!1},D=function(a){var b=new RegExp("gid=([^&#]+)","i");return b.test(a)?a.match(b)[1]:!1},E=function(a){return x(a,"label")?a.label.replace(/\s/g,""):!1},F=function(a){return E(a)||null},G=function(a){return E(a)||a.id},H=function(b,c){return a.each(c,function(a,c){b=b.replace(new RegExp("%"+c+"%","g"),a)}),b},I=function(b){return!b||b instanceof a?b:a(b)},J=function(b){var c={};return a.each(b,function(a,b){c[b]=b}),c},K=function(a){return a&&x(a,"p")&&x(a.p,"style")?a.p.style:!1},L=function(a){var b,c="",d=a.num?"td":"th";for(b in a.cells)x(a.cells,b)&&(c+=M(a.cells[b],d,""));return M(c,"tr","")},M=function(a,b,c){var d=c?' style="'+c+'"':"";return"<"+b+d+">"+a+"</"+b+">"};a.fn.sheetrock.options={url:"",sql:"",chunkSize:0,columns:{},labels:[],rowHandler:L,cellHandler:v,dataHandler:q,userCallback:a.noop,loading:a(),debug:!1,headers:0,headersOff:!1,rowGroups:!1,formatting:!1},a.fn.sheetrock.server="https://spreadsheets.google.com/tq",a.fn.sheetrock.working=0,a.fn.sheetrock.promise=a.Deferred().resolve(),a.fn.sheetrock.version="0.1.5"});
